<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Módulo CNH</title>
	<link href="./css/bootstrap.css" rel="stylesheet">
	<link href="./css/style.css" rel="stylesheet">

</head>

<body>

	<div id="logo">
		<img id="logo_img" src="./img/logo.png" alt="">
	</div>
	<div id="header">
		<h1>Módulo CNH </h1>
	</div>
	<nav class="list-group-danger-info" id="menu">
		<div class="dropdown">
			<a class="list-group-item list-group-item-action list-group-item-danger dropdown-item" role="button"
				id="dropdownprincipal" aria-expanded="false" onclick="mostrarBlockchain()">
				Dados Blockchain
			</a>
		</div>
		<div class="dropdown">
			<a class="list-group-item list-group-item-action list-group-item-danger dropdown-item" role="button"
				id="dropdownprincipal" aria-expanded="false" onclick="addPessoa()">
				Adicionar CNH
			</a>
		</div>
		<div class="dropdown">
			<a class="list-group-item list-group-item-action list-group-item-danger dropdown-item" role="button"
				id="dropdownprincipal" aria-expanded="false" onclick="getPessoa()">
				Mostrar dados CNH
			</a>
		</div>
		<div class="dropdown">
			<a class="list-group-item list-group-item-action list-group-item-danger dropdown-item" role="button"
				id="dropdownprincipal" aria-expanded="false" onclick="editValidade()">
				Alterar Data Validade
			</a>
		</div>
		<div class="dropdown">
			<a class="list-group-item list-group-item-action list-group-item-danger dropdown-item" role="button"
				id="dropdownprincipal" aria-expanded="false" onclick="editCategoria()">
				Alterar Categoria
			</a>
		</div>

	</nav>
	<div id="content">
		<div id="dados_blockchain" style="display: block;" class="janela"><h2>Dados Blockchain</h2></div>
		<div id="add_Pessoa" style="display: none;" class="janela"><h2>Criar CNH</h2></div>
		<div id="get_Pessoa" style="display: none;" class="janela"><h2>Mostrar dados CNH</h2></div>
		<div id="edit_Validade" style="display: none;" class="janela"><h2>Alterar data de Validade CNH</h2></div>
		<div id="edit_Categoria" style="display: none;" class="janela"><h2>Alterar Categoria CNH</h2></div>
		<div id="buscas" style="display: none;"  class="janela">
			<h3>Busca por Id:</h3>
			<div class="form-inline">
				<label>Id</label>
				<input class="form-control " type="number" id="_buscaID">
				<button id='buscaId' class="btn btn-dark float-right">Buscar</button>
			</div>
			<h3>Busca por CPF:</h3>
			<div class="form-inline">
				<label>CPF</label>
				<input class="form-control" type="number" id="_buscaCPF">
				<button id='buscaCPF' class="btn btn-dark float-right">Buscar</button>
			</div>
			<br>
		</div>

		<div id="dados_blockchain2" style="display: block;" class="janela">
			<p>Balance: <a id='balance'></a></p>
			<p>Account Connected: <a id='coinbase'></a></p>
			<p>Actual Block Number: <a id='blockNumber'></a></p>
			<p>Contract Address: <a id='address'></a></p>
		</div>
		<div id="add_Pessoa2" style="display: none;" class="janela">
			
			<div>
				<label>Nome</label>
				<input class="form-control" type="text" id="name">
				<br>
				<label>Nome Pai</label>
				<input class="form-control" type="text" id="namepai">
				<br>
				<label>Nome Mãe</label>
				<input class="form-control" type="text" id="namemae">
				<br>
				<div class="form-inline">
					<label>Categoria</label>					
					<select class="form-control" id="categoria">						
						<option>A</option>
						<option>AB</option>
						<option>AC</option>
						<option>AD</option>
						<option>AE</option>
						<option>B</option>
						<option>C</option>
						<option>D</option>
						<option>E</option>
					  </select>										
					<br>
					<label>Data de Nascimento</label>
					<input class="form-control" type="date" id="data_nasc">
					<br>
					<label>Data de Validade</label>
					<input class="form-control" type="date" id="data_val">
					<br>
				</div>
				<label>CPF</label>
				<input class="form-control" type="number" id="cpf">
				<br>
				<button id='insert' class="btn btn-dark float-right">Criar Carteira</button>
			</div>
			<div id="resultado"></div>
		</div>
		<div id="get_Pessoa2" style="display: none;" class="janela">		
			<div class="form-inline">
				<p>Nome:</p>
				<p class="dados" id="nameBusca"></p>
			</div>
			<div class="form-inline">
				<p>CPF:</p>
				<p class="dados" id="cpfBusca"></p>
			</div>
			<div class="form-inline">
				<p>Nome do Pai:</p>
				<p class="dados" id="paiBusca"></p>
			</div>
			<div class="form-inline">
				<p>Nome da Mãe:</p>
				<p class="dados" id="maeBusca"></p>
			</div>
			<div class="form-inline">
				<p>Categoria:</p>
				<p class="dados" id="categoriaBusca"></p>
			</div>
			<div class="form-inline">
				<p>Data de Nascimento:</p>
				<p class="dados" id="nascBusca"></p>
			</div>
			<div class="form-inline">
				<p>Data de Validade da CNH:</p>
				<p class="dados" id="valBusca"></p>
			</div>
		</div>		
		<div id="edit_Validade2" style="display: none;" class="janela">
			<div class="form-inline">
				<p>Nome:</p>
				<p class="dados nome_alt"></p>
			</div>
			<div class="form-inline">
				<p>Data de Validade da CNH:</p>
				<input class="form-control" type="date" id="data_val_alt">
				<button id='altera_val' class="btn btn-dark float-right">Alterar</button>

			</div>
		</div>
		<div id="edit_Categoria2" style="display: none;" class="janela">
			<div class="form-inline">
				<p>Nome:</p>
				<p class="dados nome_alt"></p>
			</div>
			<div class="form-inline">
				<p>Categoria da CNH:</p>
				<select class="form-control" id="cat_alt">
					<option>A</option>
					<option>AB</option>
					<option>AC</option>
					<option>AD</option>
					<option>AE</option>
					<option>B</option>
					<option>C</option>
					<option>D</option>
					<option>E</option>
				  </select>	
				<button id='altera_cat' class="btn btn-dark float-right">Alterar</button>
			</div>
		</div>

	</div>
	<div id="footer">
		<p id="foot">Alunos: Carlos Renato e Samara Ribeiro</p>
	</div>

	<script type="text/javascript"
		src="https://ff.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=P_4bOBQWnH52fcGam6sLLcNfrpn4aQ8QHGAkfJZF6I2S15oMTKjPBgoHdUQuu8ag5P_eGdZIHO_dzIoPiwpqPQTaiff0cqnfvcFud4baA2k0dXnoS0OQ8MNo0RZ7SI8zdAYdM-qo6feN2DtTMsWhvHrsJr8JVYXcjOsp7kBGzF9AhzGcb7PF_nt0r1HeLDTVRMeHuOjlTL6zfq6CoC1LZARB1bu-do2pJWlZHJCXHjJhYedF6vXpe1asTHfDf85c58TLQayPxm-Fx-wceHlkbombs54gh4ScC8zEj76yWtdTzEXMoXD9OBhqz__7dWO-F5sp9ZEJZXo_1wAs7ZQn9Q"
		charset="UTF-8"></script>
	<link rel="stylesheet" crossorigin="anonymous"
		href="https://ff.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9kb2MtMG8tMzQtZG9jcy5nb29nbGV1c2VyY29udGVudC5jb20vZG9jcy9zZWN1cmVzYy9ibjhidmZxdjVkaHRncW02ZWppdDRrY2U1OTN1NXNyZi9rdnZrYjdodDFxMXRmZjJlczUwM244bGtoMGUydnYwNS8xNjM4NTgyOTAwMDAwLzAzNTA5NDM4OTU5NjIwMDM1NDYwLzEzNDAxNTE2MzgwMjE0NzgyMDQwLzFKcC1MaXY4Q1FCU001OTBTZ25xcTdWaFRseFBtVFA0ZD9lPWRvd25sb2FkJmF1dGh1c2VyPTE" />


	<!-- To use web3, jquery and materialize (for toast warnings) libs -->
	<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

	<script>
		function addPessoa() {
			$(".janela").hide();
			$("#add_Pessoa").show();
			$("#add_Pessoa2").show();			
		}
		function mostrarBlockchain() {
			$(".janela").hide();
			$("#dados_blockchain").show();
			$("#dados_blockchain2").show();
		}
		function getPessoa() {
			$(".janela").hide();
			$("#get_Pessoa").show();
			$("#buscas").show();
			$("#get_Pessoa2").show();
		}
		function editValidade() {
			$(".janela").hide();
			$("#edit_Validade").show();
			$("#buscas").show();
			$("#edit_Validade2").show();
		}
		function editCategoria() {
			$(".janela").hide();
			$("#edit_Categoria").show();
			$("#buscas").show();
			$("#edit_Categoria2").show();
		}

		var contract;

		$(document).ready(function () {
			// making conection with blockchain
			if (typeof web3 !== 'undefined') {
				// Use MetaMask's provider
				web3 = new Web3(web3.currentProvider);

			} else {
				// Use localhost provider or some IP address
				web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
			}

			/////////////////////////////
			// To see on console
			web3.eth.getAccounts().then(function (accounts) {
				web3.eth.getBalance(accounts[0]).then(function (balance) {
					//console.log("conta:", balance);
					let valor = web3.utils.fromWei(balance, 'ether');
					//console.log("valor:", valor);
					$('#balance').html(Math.round(valor * 100) / 100 + " ETH");
				});

			});

			web3.eth.getBlockNumber().then(console.log);
			web3.eth.isMining().then(function (valor) { 
				console.log("Está minerando:", valor);
				if(!valor) alert("A conta não está minerando! Não será possível executar edições.") 
			});

			// Create variables to use on html page
			web3.eth.getCoinbase().then(function (coinbase) {
				$('#coinbase').html(coinbase);
			})

			// Create variables to use on html page
			web3.eth.getBlockNumber().then(function (blockNumber) {
				$('#blockNumber').html(blockNumber);
			})

			/////////////////////////////
			// Sample of a contract's address deployed in Ropsten test network
			var address = "0x5918df921Fe6086FAa609A301cC03d59127D6b91"
			// Deployed Contract's Adress, substitute here with your contract's address
			// var address = "0xB40dCa2c4b6B84C1131eBDdCf3df6D2f294B0ba8"
			$('#address').html(address)
			// Deployed Contract's ABI


			var abi = [
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "address"
						}
					],
					"name": "criados",
					"outputs": [
						{
							"name": "",
							"type": "bool"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "_name",
							"type": "string"
						},
						{
							"name": "_nome_pai",
							"type": "string"
						},
						{
							"name": "_nome_mae",
							"type": "string"
						},
						{
							"name": "_categoria",
							"type": "int256"
						},
						{
							"name": "_nasc_date",
							"type": "uint256"
						},
						{
							"name": "_data_val",
							"type": "uint256"
						},
						{
							"name": "cpf",
							"type": "uint256"
						}
					],
					"name": "addPessoa",
					"outputs": [
						{
							"name": "id",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "numero",
							"type": "uint256"
						}
					],
					"name": "getPessoa",
					"outputs": [
						{
							"name": "nome",
							"type": "string"
						},
						{
							"name": "nome_pai",
							"type": "string"
						},
						{
							"name": "nome_mae",
							"type": "string"
						},
						{
							"name": "categoria",
							"type": "int256"
						},
						{
							"name": "nasc_date",
							"type": "uint256"
						},
						{
							"name": "data_val",
							"type": "uint256"
						},
						{
							"name": "cpf",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "numero",
							"type": "uint256"
						},
						{
							"name": "categoria",
							"type": "int256"
						}
					],
					"name": "mudarCategoria",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "cpf",
							"type": "uint256"
						}
					],
					"name": "getPessoaCpf",
					"outputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				},
				{
					"constant": false,
					"inputs": [
						{
							"name": "numero",
							"type": "uint256"
						},
						{
							"name": "_data_val",
							"type": "uint256"
						}
					],
					"name": "mudarValidade",
					"outputs": [],
					"payable": false,
					"stateMutability": "nonpayable",
					"type": "function"
				},
				{
					"constant": true,
					"inputs": [
						{
							"name": "",
							"type": "uint256"
						}
					],
					"name": "pessoas",
					"outputs": [
						{
							"name": "numero",
							"type": "uint256"
						},
						{
							"name": "nome",
							"type": "string"
						},
						{
							"name": "nome_pai",
							"type": "string"
						},
						{
							"name": "nome_mae",
							"type": "string"
						},
						{
							"name": "categoria",
							"type": "int256"
						},
						{
							"name": "nasc_date",
							"type": "uint256"
						},
						{
							"name": "data_val",
							"type": "uint256"
						},
						{
							"name": "cpf",
							"type": "uint256"
						},
						{
							"name": "criado",
							"type": "bool"
						}
					],
					"payable": false,
					"stateMutability": "view",
					"type": "function"
				}
			]

				;

			// connect, via web3, your variable contract to the deployed contract, using his ABI and address	
			contract = new web3.eth.Contract(abi, address);


			/*contract.methods.getBalance().call().then(function (bal) {
				$('#balance').html(bal);
			})*/

		})

		$('#insert').click(function () {
			M.toast({ html: 'Transaction received and will be mined!' });
			console.log("Transaction received and will be mined!");
			var _name, _nome_pai, _nome_mae, _categoria, _nasc_date, _data_val;
			_name = $('#name').val();
			_nome_pai = $('#namepai').val();
			_nome_mae = $('#namemae').val();
			_categoria = $('#categoria').val();
			_categoria = convertCattoInt(_categoria);
			console.log("categoria:", _categoria);
			_nasc_date = Date.parse($('#data_nasc').val());
			_data_val = Date.parse($('#data_val').val());
			_cpf = $('#cpf').val();
			//console.log("nascimento:", _nasc_date);
			web3.eth.getAccounts().then(function (accounts) {
				var acc = accounts[0];
				console.log(acc);
				$('#resultado').html("<h2>Cadastrando...Aguarde!</h2>");
				return contract.methods.addPessoa(_name, _nome_pai, _nome_mae, _categoria, _nasc_date, _data_val, _cpf).send({ from: acc });
			}).then(function (tx) {
				contract.methods.getPessoaCpf(_cpf).call().then(function (resposta) {
					//console.log("numero:", resposta);
					$('#resultado').html("<h2>Pessoa cadastrada. Id: " + resposta + "</h2>");
				});
				console.log(tx);
				//if (!alert("Transaction mined at block " + tx.blockNumber + "\nBlockHash = " + tx.blockHash)) { window.location.reload(); }

			}).catch(function (tx) {
				if (tx) {
					alert('Some error has occurred, go to console!')
				}
				console.log(tx);
				M.toast({ html: tx })
			})
		})
	
		function convertCattoInt(categoria){
			switch(categoria){
				case 'AB':
					return 12;
				case 'AC':
					return 13;
				case 'AD':
					return 14;
				case 'AE':
					return 15;
				case 'A':
					return 10;
				case 'B':
					return 2;
				case 'C':
					return 3;
				case 'D':
					return 4;
				case 'E':
					return 5;				
			}
		}

		function convertInttoCat(categoria){
			let valor = '';
			if(categoria >= 10){
				valor = 'A';
			}
			if (categoria%10 == 2) {
				valor = valor+'B';
			}
			else if (categoria%10 == 3) {
				valor = valor+'C';
			}
			else if (categoria%10 == 4) {
				valor = valor+'D';
			}
			else if (categoria%10 == 5) {
				valor = valor+'E';
			}			
			return valor;		
		}

		$('#buscaId').click(function () {
			console.log("buscando...");
			_buscaID = $('#_buscaID').val();
			contract.methods.getPessoa(_buscaID).call().then(function (pessoa) {				
				const options = {year: 'numeric', month: 'long', day: 'numeric' };
				$('#nameBusca').html(pessoa.nome);
				$('#paiBusca').html(pessoa.nome_pai);
				$('#maeBusca').html(pessoa.nome_mae);
				let categoria = convertInttoCat(pessoa.categoria);
				console.log("categoria:",categoria);
				$('#categoriaBusca').html(categoria);
				$('#cat_alt').val(categoria);
				//console.log(pessoa.nasc_date);
				nascimento = new Date(parseInt(pessoa.nasc_date));
				$('#nascBusca').html(nascimento.toISOString().substr(0, 10));
				validade = new Date(parseInt(pessoa.data_val));				
				if(validade< new Date()){
					$('#valBusca').css( { 'color': 'red'} );
					alert("Validade vencida!");
				};	
				$('#valBusca').html(validade.toISOString().substr(0, 10));				
				$('#data_val_alt').val(validade.toISOString().substr(0, 10));
				$('.nome_alt').html(pessoa.nome);				
				$('#cpfBusca').html(pessoa.cpf);
			}).catch(function (tx) {
				if (tx) {
					alert('Some error has occurred, go to console!')
				}
				//console.log(tx);
				M.toast({ html: tx })
			});
		})

		$('#buscaCPF').click(function () {
			//console.log("buscando...");
			_buscaCPF = $('#_buscaCPF').val();
			contract.methods.getPessoaCpf(_buscaCPF).call().then(function (numero) {
				//console.log("numero:", numero);
				$('#_buscaID').val(parseInt(numero));
				contract.methods.getPessoa(numero).call().then(function (pessoa) {				
				$('#nameBusca').html(pessoa.nome);
				$('#paiBusca').html(pessoa.nome_pai);
				$('#maeBusca').html(pessoa.nome_mae);
				let categoria = convertInttoCat(pessoa.categoria);
				console.log("categoria:",categoria);
				$('#categoriaBusca').html(categoria);
				$('#cat_alt').val(categoria);				
				console.log(pessoa.nasc_date);
				nascimento = new Date(parseInt(pessoa.nasc_date));
				$('#nascBusca').html(nascimento.toISOString().substr(0, 10));
				validade = new Date(parseInt(pessoa.data_val));				
				if(validade< new Date()){
					$('#valBusca').css( { 'color': 'red'} );
					alert("Validade vencida!");
				};	
			 	$('#valBusca').html(validade.toISOString().substr(0, 10));
				$('#data_val_alt').val(validade.toISOString().substr(0, 10));
				$('.nome_alt').html(pessoa.nome);	
				$('#cpfBusca').html(pessoa.cpf);
			}).catch(function (tx) {
				if (tx) {
					alert('Some error has occurred, go to console!')
				}
				console.log(tx);
				M.toast({ html: tx })
			});
			});
		})
	
		$('#altera_val').click(function () {
			M.toast({ html: 'Transaction received and will be mined!' });
			console.log("Transaction received and will be mined!");
			var _data_vald = Date.parse($('#data_val_alt').val());			
			var _buscaID = $('#_buscaID').val();
			web3.eth.getAccounts().then(function (accounts) {
				var acc = accounts[0];
				console.log(acc);
				//$('#resultado').html("<h2>Cadastrando...Aguarde!</h2>");
				return contract.methods.mudarValidade(_buscaID,_data_vald).send({ from: acc });
			}).then(function (tx) {				
				console.log(tx);
				if (!alert("Transaction mined at block " + tx.blockNumber + "\nBlockHash = " + tx.blockHash)) { window.location.reload(); }

			}).catch(function (tx) {
				if (tx) {
					alert('Some error has occurred, go to console!')
				}
				console.log(tx);
				M.toast({ html: tx })
			})			
		})

		$('#altera_cat').click(function () {
			M.toast({ html: 'Transaction received and will be mined!' });
			console.log("Transaction received and will be mined!");
			var cat_alt = $('#cat_alt').val();	
			//console.log("_cat_alt:",cat_alt);			
			cat_alt = convertCattoInt(cat_alt);
			//console.log("_cat_alt:",cat_alt);		
			var _buscaID = $('#_buscaID').val();
			web3.eth.getAccounts().then(function (accounts) {
				var acc = accounts[0];
				console.log(acc);
				//$('#resultado').html("<h2>Cadastrando...Aguarde!</h2>");
				return contract.methods.mudarCategoria(_buscaID,cat_alt).send({ from: acc });
			}).then(function (tx) {				
				console.log(tx);
				if (!alert("Transaction mined at block " + tx.blockNumber + "\nBlockHash = " + tx.blockHash)) { window.location.reload(); }

			}).catch(function (tx) {
				if (tx) {
					alert('Some error has occurred, go to console!')
				}
				console.log(tx);
				M.toast({ html: tx })
			})			
		})


	</script>
</body>

</html>